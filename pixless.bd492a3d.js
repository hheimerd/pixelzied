let e,t;function n(e){return e&&e.__esModule?e.default:e}var a={};a="#define GLSLIFY 1\nattribute vec2 p;\nvarying vec2 uv;\nvoid main(){\n  uv = (p+1.0)*0.5;\n  gl_Position = vec4(p,0,1);\n}\n";var i={};i="precision mediump float;\n#define GLSLIFY 1\nvarying vec2 uv;\n\nuniform sampler2D img;\nuniform sampler2D palette; // 1D lookup texture\n\nuniform vec2 res;\nuniform float pixel;\nuniform float colors; // Number of colors in current palette\nuniform float dither;\nuniform float contrast;\nuniform float compare;\n\nfloat lum(vec3 c){ return dot(c,vec3(0.3,0.59,0.11)); }\n\nfloat bayer4(vec2 p){\n  vec2 f = mod(floor(p),4.0);\n  float x = f.x;\n  float y = f.y;\n\n  if(y==0.0) return (x==0.0?0.0:(x==1.0?8.0:(x==2.0?2.0:10.0)))/16.0;\n  if(y==1.0) return (x==0.0?12.0:(x==1.0?4.0:(x==2.0?14.0:6.0)))/16.0;\n  if(y==2.0) return (x==0.0?3.0:(x==1.0?11.0:(x==2.0?1.0:9.0)))/16.0;\n  return           (x==0.0?15.0:(x==1.0?7.0:(x==2.0?13.0:5.0)))/16.0;\n}\n\nvoid main(){\n  // 1. Pixel snapping\n  vec2 puv = floor(uv * res / pixel) * pixel / res;\n  vec3 col = texture2D(img, puv).rgb;\n\n  if (compare > 0.5) {\n      gl_FragColor = vec4(col, 1.0);\n      return;\n  }\n\n  // 2. Contrast (Simple RGB pow)\n  col = pow(col, vec3(contrast));\n\n  // 3. Dithering & Quantization\n  // We utilize a Nearest Neighbor search over the palette.\n  \n  float t = bayer4(gl_FragCoord.xy);\n  \n  // Dither strength\n  vec3 ditherShift = vec3((t - 0.5) * dither * 0.15); \n  vec3 target = clamp(col + ditherShift, 0.0, 1.0);\n\n  float minDist = 100.0;\n  vec3 bestCol = vec3(0.0);\n  \n  // Human Visual Perception Weights (Luma-based)\n  vec3 weights = vec3(0.30, 0.59, 0.11);\n\n  // Loop through palette (Max 32 colors supported)\n  for(int i=0; i < 32; i++) {\n     if(float(i) >= colors) break;\n     \n     // Sample palette center\n     float u_pos = (float(i) + 0.5) / colors;\n     vec3 palCol = texture2D(palette, vec2(u_pos, 0.5)).rgb;\n     \n     vec3 diff = target - palCol;\n     // Weighted Squared Euclidean Distance\n     float d = dot(diff * diff, weights);\n     \n     if(d < minDist) {\n         minDist = d;\n         bestCol = palCol;\n     }\n  }\n\n  gl_FragColor = vec4(bestCol, 1.0);\n}\n";let o=document.getElementById("gl"),r=o.getContext("webgl",{preserveDrawingBuffer:!0}),l=new class{constructor(){this.STORAGE_KEY="pixless_settings",this.CURRENT_VERSION=1,this.defaults={palette:"db16",colors:8,pixel:1,dither:1,contrast:1},this.state=this.load()}load(){try{let e=localStorage.getItem(this.STORAGE_KEY);if(!e)return{...this.defaults};let t=JSON.parse(e);return this._migrate(t)}catch(e){return console.error("Failed to load settings:",e),{...this.defaults}}}save(e){let t={version:this.CURRENT_VERSION,data:e};try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t)),console.log("Settings saved:",t)}catch(e){console.error("Failed to save settings:",e)}}get(){return this.state}_migrate(e){let t=e.version||0,n=e.data||e;return t<1&&(t=1),{...this.defaults,...n}}},d=l.get();function c(e,t){let n=r.createShader(e);return r.shaderSource(n,t),r.compileShader(n),r.getShaderParameter(n,r.COMPILE_STATUS)||console.error(r.getShaderInfoLog(n)),n}let s=r.createProgram();r.attachShader(s,c(r.VERTEX_SHADER,n(a))),r.attachShader(s,c(r.FRAGMENT_SHADER,n(i))),r.linkProgram(s),r.getProgramParameter(s,r.LINK_STATUS)||console.error("Link:",r.getProgramInfoLog(s)),r.useProgram(s);let m=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,m),r.bufferData(r.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),r.STATIC_DRAW);let u=r.getAttribLocation(s,"p");r.enableVertexAttribArray(u),r.vertexAttribPointer(u,2,r.FLOAT,!1,0,0);let E=!1,g=d.palette,h=null;document.getElementById("paletteSelect").value=d.palette,document.getElementById("colors").value=d.colors,document.getElementById("pixel").value=d.pixel,document.getElementById("dither").value=d.dither,document.getElementById("contrast").value=d.contrast;let f={arne16:["#000000","#9D9D9D","#FFFFFF","#BE2633","#E06F8B","#493C2B","#A46422","#EB8931","#F7E26B","#2F484E","#44891A","#A3CE27","#1B2632","#005784","#31A2F2","#B2DCEF"],db16:["#140c1c","#442434","#30346d","#4e4a4e","#854c30","#346524","#d04648","#757161","#597dce","#d27d2c","#8595a1","#6daa2c","#d2aa99","#6dc2ca","#dad45e","#deeed6"],endesga32:["#be4a2f","#d77643","#ead4aa","#e4a672","#b86f50","#733e39","#3e2731","#a22633","#e43b44","#f77622","#feae34","#fee761","#63c74d","#3e8948","#265c42","#193c3e","#124e89","#0099db","#2ce8f5","#ffffff","#c0cbdc","#8b9bb4","#5a6988","#3a4466","#262b44","#181425","#ff0044","#68386c","#b55088","#f6757a","#e8b796","#c28569"],c64:["#000000","#FFFFFF","#880000","#AAFFEE","#CC44CC","#00CC55","#0000AA","#EEEE77","#DD8855","#664400","#FF7777","#333333","#777777","#AAFF66","#0088FF","#BBBBBB"]};function y(){let e=[];if("custom"===g){let t=+document.getElementById("colors").value;for(let n=0;n<t;n++){let a=Math.floor(n/(t-1)*255);e.push(a,a,a)}}else{let t=f[g];if(!t)return;t.forEach(t=>{let n;return e.push((n=parseInt(t.slice(1),16))>>16&255,n>>8&255,255&n)})}let n=e.length/3,a=new Uint8Array(e);t&&r.deleteTexture(t),t=r.createTexture(),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texImage2D(r.TEXTURE_2D,0,r.RGB,n,1,0,r.RGB,r.UNSIGNED_BYTE,a)}function v(e){if(!e||!e.type.startsWith("image/"))return;let t=new Image;t.onload=()=>T(t),t.src=URL.createObjectURL(e)}function T(t){h=t,document.getElementById("rotateBtn").style.display="flex";let n=t.width/t.height,a=Math.sqrt(3e4/n);o.width=Math.round(a*n),o.height=Math.round(a),r.viewport(0,0,o.width,o.height),e&&r.deleteTexture(e),e=r.createTexture(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,e),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!0),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,t),E=!0;let i=document.getElementById("drop");i.classList.add("has-image");let l=document.getElementById("blur-bg");l.style.backgroundImage=`url(${t.src})`,l.style.opacity="1",document.getElementById("original-image").src=t.src,document.querySelector(".instruction").style.display="none",i.style.backgroundImage=`url(${t.src})`,i.style.backgroundSize="contain",i.style.backgroundRepeat="no-repeat",i.style.backgroundPosition="center",i.querySelector("svg").style.display="none",x(),p()}function p(){let e=document.getElementById("preview-container"),t=e.clientWidth,n=e.clientHeight,a=o.width,i=o.height;a&&i&&(a/i>t/n?(o.style.width="100%",o.style.height="auto"):(o.style.width="auto",o.style.height="100%"))}y(),window.addEventListener("resize",()=>{(E||X)&&p()});let I=document.getElementById("original-image"),_=document.getElementById("preview-container");function R(e){E&&(e.cancelable&&"mousedown"!==e.type&&e.preventDefault(),I.classList.add("visible"))}function B(e){e.cancelable&&"mouseup"!==e.type&&e.preventDefault(),I.classList.remove("visible")}function x(){if(r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT),E){let n=0;n="custom"===g?+document.getElementById("colors").value:f[g].length,r.useProgram(s),r.uniform1i(r.getUniformLocation(s,"img"),0),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,e),r.uniform1i(r.getUniformLocation(s,"palette"),1),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,t),r.uniform1f(r.getUniformLocation(s,"pixel"),+document.getElementById("pixel").value),r.uniform1f(r.getUniformLocation(s,"colors"),n),r.uniform1f(r.getUniformLocation(s,"dither"),+document.getElementById("dither").value),r.uniform1f(r.getUniformLocation(s,"contrast"),+document.getElementById("contrast").value),r.uniform2f(r.getUniformLocation(s,"res"),o.width,o.height),r.drawArrays(r.TRIANGLE_STRIP,0,4)}}_.addEventListener("touchstart",R,{passive:!1}),_.addEventListener("touchend",B),_.addEventListener("touchcancel",B),_.addEventListener("mousedown",R),_.addEventListener("mouseup",B),_.addEventListener("mouseleave",B),_.addEventListener("contextmenu",e=>e.preventDefault());let b=document.getElementById("paletteSelect"),L=document.getElementById("colors"),D=document.getElementById("colorsLabel");function A(){"custom"===g?(L.disabled=!1,D.style.opacity="1"):(L.disabled=!0,D.style.opacity="0.5")}A(),b.addEventListener("change",e=>{g=e.target.value,A(),y(),E&&requestAnimationFrame(x)}),["colors","pixel","dither","contrast"].forEach(e=>{document.getElementById(e).addEventListener("input",()=>{"colors"===e&&"custom"===g&&y(),E&&requestAnimationFrame(x)})});let U=document.getElementById("drop");U.addEventListener("dragover",e=>{e.preventDefault(),U.classList.add("drag-over")}),U.addEventListener("dragleave",()=>{U.classList.remove("drag-over")}),U.addEventListener("drop",e=>{e.preventDefault(),U.classList.remove("drag-over"),e.dataTransfer.files.length&&v(e.dataTransfer.files[0])}),U.addEventListener("click",()=>{E||F.click()});let w=document.getElementById("fileBtn"),F=document.getElementById("fileInput");w.onclick=()=>F.click(),F.onchange=e=>v(e.target.files[0]);let S=document.getElementById("saveConfigBtn");S.onclick=()=>{let e={palette:b.value,colors:+L.value,pixel:+document.getElementById("pixel").value,dither:+document.getElementById("dither").value,contrast:+document.getElementById("contrast").value};l.save(e);let t=S.innerText;S.innerText="Saved!",setTimeout(()=>S.innerText=t,1e3)};let P=null,C=null,X=!1,M=null,k=!1,G=0,N=document.getElementById("camBtn");(async()=>{if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices){N.style.display="none";return}try{(await navigator.mediaDevices.enumerateDevices()).some(e=>"videoinput"===e.kind)||(N.style.display="none")}catch(e){console.warn("Error checking camera availability:",e)}})();let O=document.getElementById("camera-controls"),W=document.getElementById("camClose"),q=document.getElementById("camSnap");function Y(){if(P&&(P.getTracks().forEach(e=>e.stop()),P=null),M&&cancelAnimationFrame(M),X=!1,O.classList.add("hidden"),window.removeEventListener("deviceorientation",H),G=0,U.style.display="flex",U.style.display="flex",document.getElementById("blur-bg").style.display="block",document.getElementById("controls").style.display="flex",document.getElementById("container").style.height="",document.getElementById("original-image").style.display="block",k){let e=document.getElementById("original-image").src;if(e){let t=new Image;t.onload=()=>T(t),t.src=e}}else h=null,document.getElementById("rotateBtn").style.display="none",E=!1,r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT),U.classList.remove("has-image"),U.style.backgroundImage="",U.querySelector("svg").style.display="block",document.querySelector(".instruction").style.display="block",document.getElementById("blur-bg").style.opacity="0"}function H(e){let t=e.beta,n=e.gamma;G=Math.abs(n)>Math.abs(t)?n>0?90:-90:t>0?0:180}N.onclick=async function t(){try{let t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080}},audio:!1});if("u">typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission)try{let e=await DeviceOrientationEvent.requestPermission();"granted"===e&&window.addEventListener("deviceorientation",H)}catch(e){console.warn("Gyroscope permission failed",e)}else window.addEventListener("deviceorientation",H);P=t,(C=document.createElement("video")).srcObject=t,C.autoplay=!0,C.playsInline=!0,await C.play(),await C.play(),X=!0,k=E,O.classList.remove("hidden"),U.style.display="none",document.getElementById("blur-bg").style.display="none",document.getElementById("original-image").style.display="none",X=!0,O.classList.remove("hidden"),U.style.display="none",document.getElementById("blur-bg").style.display="none",document.getElementById("original-image").style.display="none",document.getElementById("controls").style.display="none",document.getElementById("container").style.height="100vh",function t(){if(X){if(C.readyState===C.HAVE_ENOUGH_DATA){e||(e=r.createTexture()),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,e),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!0),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,C);let t=C.videoWidth/C.videoHeight,n=Math.sqrt(3e4/t),a=n*t;(o.width!==Math.round(a)||o.height!==Math.round(n))&&(o.width=Math.round(a),o.height=Math.round(n),o.height=Math.round(n),r.viewport(0,0,o.width,o.height)),p();let i=E;E=!0,x(),E=i}M=requestAnimationFrame(t)}}()}catch(e){console.error("Camera access denied",e),alert("Could not access camera. Please allow permissions.")}},W.onclick=Y,q.onclick=function(){if(!C)return;let e=document.createElement("canvas"),t=C.videoWidth,n=C.videoHeight,a=G;90===Math.abs(a)?(e.width=n,e.height=t):(e.width=t,e.height=n);let i=e.getContext("2d");i.translate(e.width/2,e.height/2),i.rotate(a*Math.PI/180),i.drawImage(C,-t/2,-n/2),e.toBlob(e=>{let t=new File([e],"camera_capture.png",{type:"image/png"});Y(),v(t)},"image/png")},document.getElementById("saveBtn").onclick=()=>{if(!E)return;let e=o.width,t=o.height,n=Math.ceil(2048/Math.max(e,t));n<1&&(n=1);let a=document.createElement("canvas");a.width=e*n,a.height=t*n;let i=a.getContext("2d");i.imageSmoothingEnabled=!1,i.webkitImageSmoothingEnabled=!1,i.mozImageSmoothingEnabled=!1,i.drawImage(o,0,0,a.width,a.height);let r=document.createElement("a");r.download="pixel_art.png",r.href=a.toDataURL(),r.click()};let K=document.getElementById("rotateBtn");["mousedown","touchstart","mouseup","touchend","click"].forEach(e=>{K.addEventListener(e,e=>e.stopPropagation())}),K.onclick=()=>{if(!h)return;let e=document.createElement("canvas");e.width=h.height,e.height=h.width;let t=e.getContext("2d");t.translate(0,e.height),t.rotate(-90*Math.PI/180),t.drawImage(h,0,0);let n=new Image;n.onload=()=>{T(n)},n.src=e.toDataURL()};